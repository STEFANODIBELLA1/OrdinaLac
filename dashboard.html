<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Ottico</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none; }
    .modal-overlay { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    select:disabled { background-color: #f3f4f6; opacity: 0.7; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div id="login-view" class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Dashboard Ottico</h2>
      <div class="space-y-4">
        <div><label for="email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
        <div><label for="password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
        <p id="login-error" class="text-red-500 text-sm hidden"></p>
        <button id="login-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-lg font-semibold hover:bg-blue-700">Accedi</button>
        <button id="register-button" class="w-full bg-gray-600 text-white py-2 px-4 rounded-md shadow-lg font-semibold hover:bg-gray-700">Registrati (primo accesso)</button>
      </div>
    </div>
  </div>

  <div id="dashboard-view" class="hidden">
    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 items-center">
        <div class="flex items-center space-x-4">
          <h1 class="text-xl font-bold text-blue-600">Ordini Clienti</h1>
          <button id="add-client-button" class="bg-green-600 text-white py-2 px-4 rounded-md shadow-sm text-sm font-medium hover:bg-green-700">+ Inserisci Cliente</button>
          <button id="manage-lenses-button" class="bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700">Gestisci Lenti</button>
        </div>
        <div class="flex items-center">
          <span id="user-email" class="text-sm text-gray-600 mr-4"></span>
          <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-md shadow-sm text-sm font-medium hover:bg-red-600">Esci</button>
        </div>
      </div>
    </nav>
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
      <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
        <p class="font-bold">Il tuo Codice Ottico</p>
        <p>Comunica questo codice ai tuoi pazienti (per l'inserimento manuale).</p>
        <code id="optician-id-code" class="block bg-white text-gray-800 font-mono text-lg p-2 mt-2 rounded break-all">...</code>
      </div>
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ordini in Arrivo</h2>
      <div id="orders-list" class="space-y-4">
        <p id="loading-orders" class="text-gray-500">Caricamento ordini...</p>
      </div>
    </main>
  </div>

  <div id="client-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-6 hidden z-50">
    <div class="bg-white w-full max-w-lg rounded-lg shadow-xl modal-content relative">
      <div id="client-form-container" class="p-6 space-y-4">
        <h1 class="text-2xl font-bold text-gray-800">Inserisci Nuovo Cliente</h1>
        <p class="text-gray-600">Compila i dati del cliente per generare il suo link di installazione rapida.</p>
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-2">Dati Paziente</h2>
        <div><label for="client-name" class="block text-sm font-medium text-gray-700">Nome Cliente</label><input type="text" id="client-name" placeholder="Es: Mario Rossi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Lente Cliente</h2>
        <div><label for="client-lens-manufacturer" class="block text-sm font-medium text-gray-700">Produttore</label><select id="client-lens-manufacturer" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">-- Seleziona Produttore --</option></select></div>
        <div><label for="client-lens-model" class="block text-sm font-medium text-gray-700">Modello Lente</label><select id="client-lens-model" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" disabled><option value="">-- Prima seleziona produttore --</option></select></div>
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Occhio Destro (OD)</h2>
        <div><label for="client-lens-type-od" class="block text-sm font-medium text-gray-700">Tipo Correzione (Destro)</label><select id="client-lens-type-od" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" disabled><option value="">-- Seleziona Tipo --</option></select></div>
        <div id="client-prescription-fields-od" class="space-y-2">
          <p id="client-params-info-od" class="text-sm text-gray-500">Seleziona un tipo di correzione.</p>
          <div id="client-params-pwr-od" class="hidden"><input type="text" id="client-param-pwr-od" placeholder="Potere (PWR)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
          <div id="client-params-cyl-od" class="hidden"><input type="text" id="client-param-cyl-od" placeholder="Cilindro (CYL)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
          <div id="client-params-axis-od" class="hidden"><input type="text" id="client-param-axis-od" placeholder="Asse (AXIS)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
          <div id="client-params-add-od" class="hidden"><input type="text" id="client-param-add-od" placeholder="Addizione (ADD)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
        </div>
        <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Occhio Sinistro (OS)</h2>
        <div><label for="client-lens-type-os" class="block text-sm font-medium text-gray-700">Tipo Correzione (Sinistro)</label><select id="client-lens-type-os" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" disabled><option value="">-- Seleziona Tipo --</option></select></div>
        <div id="client-prescription-fields-os" class="space-y-2">
          <p id="client-params-info-os" class="text-sm text-gray-500">Seleziona un tipo di correzione.</p>
          <div id="client-params-pwr-os" class="hidden"><input type="text" id="client-param-pwr-os" placeholder="Potere (PWR)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
          <div id="client-params-cyl-os" class="hidden"><input type="text" id="client-param-cyl-os" placeholder="Cilindro (CYL)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
          <div id="client-params-axis-os" class="hidden"><input type="text" id="client-param-axis-os" placeholder="Asse (AXIS)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
          <div id="client-params-add-os" class="hidden"><input type="text" id="client-param-add-os" placeholder="Addizione (ADD)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
        </div>
      </div>
      <div id="client-qr-container" class="p-6 text-center hidden">
        <h1 class="text-2xl font-bold text-gray-800">Link Cliente Generato</h1>
        <p class="text-gray-600 mb-4">Fai scansionare questo QR code al tuo cliente per installare l'app pre-configurata.</p>
        <div id="qr-code-display" class="flex justify-center p-4 bg-white border rounded-lg"></div>
        <div class="mt-6 flex space-x-4">
            <button id="close-qr-button" class="w-1/2 bg-gray-600 text-white py-2 px-4 rounded-md shadow-lg font-semibold hover:bg-gray-700">Fatto</button>
            <button id="print-qr-button" class="w-1/2 bg-blue-600 text-white py-2 px-4 rounded-md shadow-lg font-semibold hover:bg-blue-700">Stampa QR</button>
        </div>
      </div>
      <div id="client-form-actions" class="bg-gray-50 px-6 py-4 flex justify-end space-x-4 rounded-b-lg">
        <button id="close-modal-button" class="bg-gray-600 text-white py-2 px-4 rounded-md shadow-lg font-semibold hover:bg-gray-700">Annulla</button>
        <button id="generate-qr-button" class="bg-green-600 text-white py-2 px-4 rounded-md shadow-lg font-semibold hover:bg-green-700">Genera QR Code</button>
      </div>
    </div>
  </div>

  <div id="lens-manager-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-6 hidden z-50">
    <div class="bg-white w-full max-w-2xl rounded-lg shadow-xl modal-content relative">
      <button id="close-lens-manager-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
      <div class="p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Gestione Lenti a Contatto</h1>
        <p class="text-sm text-gray-600 mb-4">Aggiungi o rimuovi le lenti che i tuoi clienti possono ordinare. Le modifiche sono istantanee.</p>
        <div class="bg-gray-50 p-4 rounded-lg border space-y-4">
          <h3 class="text-lg font-semibold">Aggiungi Nuovo</h3>
          <div class="flex space-x-2">
            <input type="text" id="new-manufacturer-name" placeholder="Nome Nuovo Produttore" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            <button id="add-manufacturer-button" class="bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600">Aggiungi</button>
          </div>
          <div class="flex space-x-2">
            <select id="manufacturer-select-for-model" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">Seleziona Produttore</option></select>
            <input type="text" id="new-model-name" placeholder="Nome Nuovo Modello" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            <button id="add-model-button" class="bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600">Aggiungi</button>
          </div>
          <div class="flex space-x-2">
            <select id="manufacturer-select-for-type" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">Seleziona Produttore</option></select>
            <select id="model-select-for-type" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" disabled><option value="">Seleziona Modello</option></select>
            <input type="text" id="new-type-name" placeholder="Nuovo Tipo (es. Toric)" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            <button id="add-type-button" class="bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600">Aggiungi</button>
          </div>
        </div>
        <h3 class="text-lg font-semibold mt-6 mb-2">Lista Lenti Attuali</h3>
        <div id="lens-manager-list" class="border rounded-lg p-4 bg-white h-64 overflow-y-auto">
          <p id="lens-manager-loading">Caricamento lista lenti...</p>
        </div>
      </div>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, setLogLevel, where, doc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = "ordinalac-app";
    const firebaseConfig = {
      apiKey: "AIzaSyDMRWXipp7VCMQiezOZSSZAhSQo8MWVgKs",
      authDomain: "ordinalac.firebaseapp.com",
      projectId: "ordinalac",
      storageBucket: "ordinalac.firebasestorage.app",
      messagingSenderId: "642877461161",
      appId: "1:642877461161:web:6a4d979e7a7ddd56140fb8"
    };

    // DB Lenti di Default (LISTA COMPLETA)
    const defaultLensData = {
      "Johnson & Johnson": {
        "Acuvue Oasys 1-Day": ["Standard", "Astigmatismo", "MAX 1-Day Multifocal"],
        "1-Day Acuvue Moist": ["Standard", "Astigmatismo", "Multifocal"],
        "Acuvue Oasys (Quindicinale)": ["Standard", "Astigmatismo", "Multifocal"],
        "Acuvue Vita (Mensile)": ["Standard", "Astigmatismo", "Multifocal"]
      },
      "Alcon": {
        "Dailies Total 1": ["Standard", "Astigmatismo", "Multifocal"],
        "Dailies AquaComfort Plus": ["Standard", "Astigmatismo", "Multifocal"],
        "Precision 1": ["Standard", "Astigmatismo", "Multifocal"],
        "Air Optix plus HydraGlyde (Mensile)": ["Standard", "Astigmatismo", "Multifocal"],
        "TOTAL30 (Mensile)": ["Standard", "Astigmatismo", "Multifocal"]
      },
      "CooperVision": {
        "MyDay (Giornaliera)": ["Standard", "Toric", "Multifocal"],
        "Clariti 1 Day (Giornaliera)": ["Standard", "Toric", "Multifocal"],
        "Biofinity (Mensile)": ["Standard", "Toric", "Multifocal", "XR"]
      },
      "Bausch + Lomb": {
        "Biotrue ONEday": ["Standard", "Astigmatismo", "Presbiopia"],
        "ULTRA ONEday": ["Standard"],
        "ULTRA (Mensile)": ["Standard", "Astigmatismo", "Presbiopia"],
        "PureVision 2 HD (Mensile)": ["Standard", "Astigmatismo", "Presbiopia"]
      }
    };
    
    let db, auth, unsubscribeOrders;
    let currentOpticianUid = null; 
    let globalLensData = null; 

    try {
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      setLogLevel('debug');
    } catch (e) { console.error("Errore inizializzazione Firebase:", e); }

    // Variabili UI
    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');
    const logoutButton = document.getElementById('logout-button');
    const loginError = document.getElementById('login-error');
    const userEmailDisplay = document.getElementById('user-email');
    const opticianIdCode = document.getElementById('optician-id-code');
    const ordersList = document.getElementById('orders-list');
    const loadingOrders = document.getElementById('loading-orders');
    
    // Variabili Modal Cliente
    const clientModal = document.getElementById('client-modal');
    const addClientButton = document.getElementById('add-client-button');
    const closeModalButton = document.getElementById('close-modal-button');
    const generateQrButton = document.getElementById('generate-qr-button');
    const clientFormContainer = document.getElementById('client-form-container');
    const clientFormActions = document.getElementById('client-form-actions');
    const clientQrContainer = document.getElementById('client-qr-container');
    const qrCodeDisplay = document.getElementById('qr-code-display');
    const closeQrButton = document.getElementById('close-qr-button');
    const printQrButton = document.getElementById('print-qr-button'); // *** NUOVO ***
    const clientNameInput = document.getElementById('client-name');
    const clientManufacturerSelect = document.getElementById('client-lens-manufacturer');
    const clientModelSelect = document.getElementById('client-lens-model');
    const clientTypeSelect_OD = document.getElementById('client-lens-type-od');
    const clientParamsInfo_OD = document.getElementById('client-params-info-od');
    const clientPwrField_OD = document.getElementById('client-params-pwr-od');
    const clientCylField_OD = document.getElementById('client-params-cyl-od');
    const clientAxisField_OD = document.getElementById('client-params-axis-od');
    const clientAddField_OD = document.getElementById('client-params-add-od');
    const clientPwrInput_OD = document.getElementById('client-param-pwr-od');
    const clientCylInput_OD = document.getElementById('client-param-cyl-od');
    const clientAxisInput_OD = document.getElementById('client-param-axis-od');
    const clientAddInput_OD = document.getElementById('client-param-add-od');
    const clientTypeSelect_OS = document.getElementById('client-lens-type-os');
    const clientParamsInfo_OS = document.getElementById('client-params-info-os');
    const clientPwrField_OS = document.getElementById('client-params-pwr-os');
    const clientCylField_OS = document.getElementById('client-params-cyl-os');
    const clientAxisField_OS = document.getElementById('client-params-axis-os');
    const clientAddField_OS = document.getElementById('client-params-add-os');
    const clientPwrInput_OS = document.getElementById('client-param-pwr-os');
    const clientCylInput_OS = document.getElementById('client-param-cyl-os');
    const clientAxisInput_OS = document.getElementById('client-param-axis-os');
    const clientAddInput_OS = document.getElementById('client-param-add-os');
    
    // Variabili Modal Gestione Lenti
    const lensManagerModal = document.getElementById('lens-manager-modal');
    const manageLensesButton = document.getElementById('manage-lenses-button');
    const closeLensManagerButton = document.getElementById('close-lens-manager-button');
    const lensManagerList = document.getElementById('lens-manager-list');
    const lensManagerLoading = document.getElementById('lens-manager-loading');
    const newManufacturerNameInput = document.getElementById('new-manufacturer-name');
    const addManufacturerButton = document.getElementById('add-manufacturer-button');
    const manufacturerSelectForModel = document.getElementById('manufacturer-select-for-model');
    const newModelNameInput = document.getElementById('new-model-name');
    const addModelButton = document.getElementById('add-model-button');
    const manufacturerSelectForType = document.getElementById('manufacturer-select-for-type');
    const modelSelectForType = document.getElementById('model-select-for-type');
    const newTypeNameInput = document.getElementById('new-type-name');
    const addTypeButton = document.getElementById('add-type-button');


    // *** FUNZIONI DI LOGIN E REGISTRAZIONE (COMPLETE) ***
    loginButton.addEventListener('click', async () => {
      try {
        loginError.classList.add('hidden');
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      } catch (error) {
        loginError.innerText = error.message;
        loginError.classList.remove('hidden');
      }
    });

    registerButton.addEventListener('click', async () => {
      try {
        loginError.classList.add('hidden');
        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        alert('Registrazione completata! Ora puoi accedere.');
      } catch (error) {
        loginError.innerText = error.message;
        loginError.classList.remove('hidden');
      }
    });

    logoutButton.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentOpticianUid = user.uid;
        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        userEmailDisplay.innerText = user.email;
        opticianIdCode.innerText = user.uid;
        loadOrders(user.uid);
        await loadLensData();
      } else {
        currentOpticianUid = null;
        loginView.classList.remove('hidden');
        dashboardView.classList.add('hidden');
        if (unsubscribeOrders) unsubscribeOrders();
      }
    });

    // *** FUNZIONE GESTIONE ORDINI (COMPLETE) ***
    function loadOrders(opticianUid) {
      const q = query(
        collection(db, `artifacts/${appId}/public/data/orders`),
        where("optician_id", "==", opticianUid) 
      );
      unsubscribeOrders = onSnapshot(q, (snapshot) => {
        loadingOrders.classList.add('hidden');
        const myOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        myOrders.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        renderOrders(myOrders);
      }, (error) => {
          console.error("Errore durante l'ascolto degli ordini:", error);
          loadingOrders.innerText = "Errore nel caricamento degli ordini.";
          if (error.code === 'failed-precondition') {
            loadingOrders.innerHTML += '<br>Potrebbe essere necessario creare un indice in Firestore. Controlla la console.';
          }
      });
    }

    function renderOrders(orders) {
      ordersList.innerHTML = '';
      if (orders.length === 0) {
        ordersList.innerHTML = '<p class="text-gray-500">Nessun ordine trovato.</p>';
        return;
      }
      for (const order of orders) {
        const date = order.timestamp?.seconds ? new Date(order.timestamp.seconds * 1000).toLocaleString('it-IT') : '';
        const el = document.createElement('div');
        el.className = 'bg-white p-6 rounded-lg shadow-md';
        el.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Da: ${order.patient_name || 'Sconosciuto'}</h3>
              <span class="text-sm text-gray-500">${date}</span>
            </div>
            <span class="mt-1 inline-block bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${order.status || ''}</span>
          </div>
          <p class="text-gray-700 whitespace-pre-wrap mt-4">${order.message}</p>
          <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-4">
            <button class="print-button bg-blue-500 text-white py-1 px-3 rounded-md text-sm hover:bg-blue-600">Stampa</button>
            <button class="delete-button bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600">Cancella</button>
          </div>
        `;
        ordersList.appendChild(el);
        el.querySelector('.print-button').addEventListener('click', () => { printOrder(order); });
        el.querySelector('.delete-button').addEventListener('click', () => { deleteOrder(order.id); });
      }
    }
    
    function printOrder(order) {
      const printWindow = window.open('', '_blank', 'height=600,width=800');
      const date = order.timestamp?.seconds ? new Date(order.timestamp.seconds * 1000).toLocaleString('it-IT') : 'N/D';
      const message = order.message.replace(/\n/g, '<br>');
      printWindow.document.write('<html><head><title>Stampa Ordine</title><style>body{font-family:sans-serif;padding:20px}h1{font-size:24px}p{font-size:16px;white-space:pre-wrap}.details{font-size:14px;color:#555}</style></head><body>');
      printWindow.document.write(`<h1>Ordine Cliente: ${order.patient_name}</h1><p class="details">Ricevuto il: ${date}</p><hr style="margin:20px 0;"><p>${message}</p></body></html>`);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }
    
    async function deleteOrder(orderId) {
      if (!confirm('Sei sicuro di voler eliminare questo ordine? L\'azione è irreversibile.')) {
        return;
      }
      try {
        const docRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
        await deleteDoc(docRef);
      } catch (e) {
        console.error("Errore durante l'eliminazione dell'ordine: ", e);
        alert("Impossibile eliminare l'ordine. Riprova.");
      }
    }

    // *** LOGICA GESTIONE LENTI (MODIFICATA PER PER-OTTICO) ***
    async function loadLensData() {
      if (!currentOpticianUid) return;
      const docRef = doc(db, "optician_config", currentOpticianUid, "lenses", "main");
      try {
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          globalLensData = docSnap.data().data;
        } else {
          console.warn("Documento lenti non trovato. Creazione con dati di default...");
          globalLensData = defaultLensData;
          await saveLensData();
        }
      } catch (e) {
        console.error("Errore caricamento lenti:", e);
        alert("Impossibile caricare la lista delle lenti.");
        globalLensData = defaultLensData;
      }
      clientPopulateManufacturers();
    }
    
    async function saveLensData() {
      if (!globalLensData || !currentOpticianUid) {
        console.error("Dati lenti o ID ottico non presenti, impossibile salvare.");
        return;
      }
      try {
        const docRef = doc(db, "optician_config", currentOpticianUid, "lenses", "main");
        await setDoc(docRef, { data: globalLensData });
        
        populateLensManagerList(); 
        clientPopulateManufacturers();
        
      } catch (e) {
        console.error("Errore salvataggio lenti:", e);
        alert("Impossibile salvare le modifiche alle lenti. Controlla le regole di Firestore.");
      }
    }

    function populateLensManagerList() {
      if (!globalLensData) {
        lensManagerLoading.classList.remove('hidden');
        lensManagerList.innerHTML = '';
        return;
      }
      lensManagerLoading.classList.add('hidden');
      lensManagerList.innerHTML = '';
      
      let manufOptions = '<option value="">Seleziona Produttore</option>';
      for (const manufacturer in globalLensData) {
        manufOptions += `<option value="${manufacturer}">${manufacturer}</option>`;
        let modelsHTML = '';
        for (const model in globalLensData[manufacturer]) {
          let typesHTML = '';
          globalLensData[manufacturer][model].forEach(type => {
            typesHTML += `<div class="ml-4 flex justify-between items-center text-sm">
              <span>- ${type}</span>
              <button class="lens-delete text-red-500 hover:text-red-700 text-xs" data-manufacturer="${manufacturer}" data-model="${model}" data-type="${type}">Elimina</button>
            </div>`;
          });
          modelsHTML += `<div class="ml-4 mt-1">
            <div class="flex justify-between items-center font-semibold">
              <span>${model}</span>
              <button class="lens-delete text-red-500 hover:text-red-700 text-xs" data-manufacturer="${manufacturer}" data-model="${model}">Elimina Modello</button>
            </div>
            ${typesHTML}
          </div>`;
        }
        lensManagerList.innerHTML += `<div class="mb-2 p-2 border-b">
          <div class="flex justify-between items-center font-bold">
            <span>${manufacturer}</span>
            <button class="lens-delete text-red-500 hover:text-red-700 text-xs" data-manufacturer="${manufacturer}">Elimina Produttore</button>
          </div>
          ${modelsHTML}
        </div>`;
      }
      
      manufacturerSelectForModel.innerHTML = manufOptions;
      manufacturerSelectForType.innerHTML = manufOptions;
      
      document.querySelectorAll('.lens-delete').forEach(button => {
        button.onclick = handleLensDelete;
      });
    }
    
    function showLensManagerModal() {
      populateLensManagerList();
      lensManagerModal.classList.remove('hidden');
    }
    
    function hideLensManagerModal() {
      lensManagerModal.classList.add('hidden');
    }
    
    async function handleLensDelete(e) {
      const { manufacturer, model, type } = e.target.dataset;
      if (type) {
        if (!confirm(`Sei sicuro di voler eliminare il tipo "${type}" dal modello "${model}"?`)) return;
        const typeIndex = globalLensData[manufacturer][model].indexOf(type);
        if (typeIndex > -1) globalLensData[manufacturer][model].splice(typeIndex, 1);
      } else if (model) {
        if (!confirm(`Sei sicuro di voler eliminare il modello "${model}" e tutti i suoi tipi?`)) return;
        delete globalLensData[manufacturer][model];
      } else if (manufacturer) {
        if (!confirm(`Sei sicuro di voler eliminare il produttore "${manufacturer}" e tutti i suoi modelli?`)) return;
        delete globalLensData[manufacturer];
      }
      await saveLensData();
    }

    addManufacturerButton.onclick = async () => {
      const name = newManufacturerNameInput.value.trim();
      if (!name) return alert("Inserisci un nome per il produttore.");
      if (globalLensData[name]) return alert("Questo produttore esiste già.");
      globalLensData[name] = {};
      newManufacturerNameInput.value = '';
      await saveLensData();
    };

    addModelButton.onclick = async () => {
      const manufacturer = manufacturerSelectForModel.value;
      const name = newModelNameInput.value.trim();
      if (!manufacturer) return alert("Seleziona un produttore.");
      if (!name) return alert("Inserisci un nome per il modello.");
      if (globalLensData[manufacturer][name]) return alert("Questo modello esiste già.");
      globalLensData[manufacturer][name] = [];
      newModelNameInput.value = '';
      await saveLensData();
    };
    
    manufacturerSelectForType.onchange = () => {
      const manuf = manufacturerSelectForType.value;
      modelSelectForType.innerHTML = '<option value="">Seleziona Modello</option>';
      modelSelectForType.disabled = true;
      if (manuf && globalLensData[manuf]) {
        Object.keys(globalLensData[manuf]).forEach(m => modelSelectForType.innerHTML += `<option value="${m}">${m}</option>`);
        modelSelectForType.disabled = false;
      }
    };
    
    addTypeButton.onclick = async () => {
      const manufacturer = manufacturerSelectForType.value;
      const model = modelSelectForType.value;
      const name = newTypeNameInput.value.trim();
      if (!manufacturer || !model) return alert("Seleziona un produttore e un modello.");
      if (!name) return alert("Inserisci un nome per il tipo.");
      if (globalLensData[manufacturer][model].includes(name)) return alert("Questo tipo esiste già.");
      globalLensData[manufacturer][model].push(name);
      newTypeNameInput.value = '';
      await saveLensData();
    };

    manageLensesButton.addEventListener('click', showLensManagerModal);
    closeLensManagerButton.addEventListener('click', hideLensManagerModal);

    // --- LOGICA MODAL CLIENTE (COMPLETA) ---
    function clientPopulateManufacturers() {
      clientManufacturerSelect.innerHTML = '<option value="">-- Seleziona Produttore --</option>';
      if (!globalLensData) return;
      Object.keys(globalLensData).forEach(m => clientManufacturerSelect.innerHTML += `<option value="${m}">${m}</option>`);
    }

    function clientPopulateModels() {
      const manuf = clientManufacturerSelect.value;
      clientModelSelect.innerHTML = '<option value="">-- Seleziona Modello --</option>';
      clientModelSelect.disabled = true;
      clientResetEyeSection('od');
      clientResetEyeSection('os');
      if (manuf && globalLensData[manuf]) {
        Object.keys(globalLensData[manuf]).forEach(m => clientModelSelect.innerHTML += `<option value="${m}">${m}</option>`);
        clientModelSelect.disabled = false;
      }
    }

    function clientPopulateTypes() {
      const manuf = clientManufacturerSelect.value;
      const model = clientModelSelect.value;
      clientResetEyeSection('od');
      clientResetEyeSection('os');
      if (manuf && model && globalLensData[manuf][model]) {
        const types = globalLensData[manuf][model];
        let optionsHTML = '<option value="">-- Seleziona Tipo --</option>';
        types.forEach(t => optionsHTML += `<option value="${t}">${t}</option>`);
        clientTypeSelect_OD.innerHTML = optionsHTML;
        clientTypeSelect_OS.innerHTML = optionsHTML;
        clientTypeSelect_OD.disabled = false;
        clientTypeSelect_OS.disabled = false;
      }
    }
    
    function clientResetEyeSection(eyeSuffix) {
      const typeSelect = (eyeSuffix === 'od') ? clientTypeSelect_OD : clientTypeSelect_OS;
      typeSelect.innerHTML = '<option value="">-- Seleziona Tipo --</option>';
      typeSelect.disabled = true;
      clientUpdateParameterFields(eyeSuffix, true);
    }

    function clientUpdateParameterFields(eyeSuffix, forceHide = false) {
      const typeSelect = (eyeSuffix === 'od') ? clientTypeSelect_OD : clientTypeSelect_OS;
      const pwrField = (eyeSuffix === 'od') ? clientPwrField_OD : clientPwrField_OS;
      const cylField = (eyeSuffix === 'od') ? clientCylField_OD : clientCylField_OS;
      const axisField = (eyeSuffix === 'od') ? clientAxisField_OD : clientAxisField_OS;
      const addField = (eyeSuffix === 'od') ? clientAddField_OD : clientAddField_OS;
      const paramsInfo = (eyeSuffix === 'od') ? clientParamsInfo_OD : clientParamsInfo_OS;
      const type = typeSelect.value.toLowerCase();
      pwrField.classList.add('hidden');
      cylField.classList.add('hidden');
      axisField.classList.add('hidden');
      addField.classList.add('hidden');
      paramsInfo.classList.remove('hidden');
      if (forceHide || !type) return;
      paramsInfo.classList.add('hidden');
      if (type.includes('standard')) { pwrField.classList.remove('hidden'); }
      else if (type.includes('astigmatismo') || type.includes('toric')) { pwrField.classList.remove('hidden'); cylField.classList.remove('hidden'); axisField.classList.remove('hidden'); }
      else if (type.includes('multifocal') || type.includes('presbiopia')) { pwrField.classList.remove('hidden'); addField.classList.remove('hidden'); }
      else if (type.includes('xr')) { pwrField.classList.remove('hidden'); cylField.classList.remove('hidden'); axisField.classList.remove('hidden'); }
    }
    
    function showClientModal() {
      clientPopulateManufacturers();
      clientPopulateModels();
      clientNameInput.value = '';
      clientPwrInput_OD.value = ''; clientCylInput_OD.value = ''; clientAxisInput_OD.value = ''; clientAddInput_OD.value = '';
      clientPwrInput_OS.value = ''; clientCylInput_OS.value = ''; clientAxisInput_OS.value = ''; clientAddInput_OS.value = '';
      clientFormContainer.classList.remove('hidden');
      clientFormActions.classList.remove('hidden');
      clientQrContainer.classList.add('hidden');
      clientModal.classList.remove('hidden');
    }
    
    function hideClientModal() {
      clientModal.classList.add('hidden');
    }
    
    function generateQR() {
      if (!currentOpticianUid) {
        alert("Errore: Ottico non autenticato.");
        return;
      }
      const data = {
        n: clientNameInput.value,
        oid: currentOpticianUid,
        m: clientManufacturerSelect.value,
        md: clientModelSelect.value,
        tod: clientTypeSelect_OD.value,
        pod: clientPwrInput_OD.value,
        cod: clientCylInput_OD.value,
        aod: clientAxisInput_OD.value,
        addod: clientAddInput_OD.value,
        tos: clientTypeSelect_OS.value,
        pos: clientPwrInput_OS.value,
        cos: clientCylInput_OS.value,
        aos: clientAxisInput_OS.value,
        addos: clientAddInput_OS.value,
      };
      if (!data.n || !data.m || !data.md) {
        alert("Compila almeno Nome, Produttore e Modello.");
        return;
      }
      const baseUrl = window.location.origin + '/';
      const params = new URLSearchParams();
      for (const [key, value] of Object.entries(data)) {
        if (value) { params.set(key, value); }
      }
      const fullUrl = baseUrl + '?' + params.toString();
      qrCodeDisplay.innerHTML = ''; 
      new QRCode(qrCodeDisplay, {
        text: fullUrl,
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
      clientFormContainer.classList.add('hidden');
      clientFormActions.classList.add('hidden');
      clientQrContainer.classList.remove('hidden');
    }
    
    // *** NUOVA FUNZIONE: Stampa QR Code ***
    function printQRCode() {
      const clientName = clientNameInput.value || "Cliente";
      const qrImage = qrCodeDisplay.querySelector('img');
      
      if (!qrImage) {
        alert("Errore: Immagine QR non trovata.");
        return;
      }
      
      const qrImageSrc = qrImage.src; // Questo è il data URL
      
      const printWindow = window.open('', '_blank', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Stampa QR Code Cliente</title>');
      printWindow.document.write('<style>body { font-family: sans-serif; padding: 20px; text-align: center; } h1 { font-size: 24px; } img { max-width: 80%; } </style>');
      printWindow.document.write('</head><body>');
      printWindow.document.write(`<h1>Accesso App per: ${clientName}</h1>`);
      printWindow.document.write('<p>Scansiona questo QR code per configurare l\'app:</p>');
      printWindow.document.write(`<img src="${qrImageSrc}" alt="QR Code">`);
      printWindow.document.write('</body></html>');
      
      printWindow.document.close();
      printWindow.focus();
      
      // La maggior parte dei browser moderni non ha bisogno di onload per le data-uri
      printWindow.print();
    }
    
    // Listener per il modal CLIENTE
    addClientButton.addEventListener('click', showClientModal);
    closeModalButton.addEventListener('click', hideClientModal);
    closeQrButton.addEventListener('click', hideClientModal);
    printQrButton.addEventListener('click', printQRCode); // *** NUOVO LISTENER ***
    generateQrButton.addEventListener('click', generateQR);
    clientManufacturerSelect.onchange = clientPopulateModels;
    clientModelSelect.onchange = clientPopulateTypes;
    clientTypeSelect_OD.onchange = () => clientUpdateParameterFields('od');
    clientTypeSelect_OS.onchange = () => clientUpdateParameterFields('os');

  </script>
</body>
</html>